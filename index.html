 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>SALAMTK â€” OCR & Admin (V73)</title>

<!-- Fonts + Tailwind -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- Libraries -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- pdf.js worker -->
<script>pdfjsLib = window['pdfjs-dist/build/pdf']; pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --accent:#f59e0b; }
  body { font-family: 'Tajawal', system-ui, sans-serif; background:var(--bg); color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .camera-container { position:relative; width:100%; height:350px; background:#000; border-radius:14px; overflow:hidden; border:4px solid #ef4444; transition:.25s; }
  .camera-container.success{ border-color:#10b981; box-shadow:0 0 28px rgba(16,185,129,.15); }
  .scan-box { position:absolute; top:20%; left:8%; right:8%; bottom:20%; border-radius:10px; border:2px dashed rgba(255,255,255,.12); pointer-events:none; z-index:10; }
  .scan-line { position:absolute; left:8%; right:8%; top:20%; height:3px; background:linear-gradient(90deg,#ef4444,#f97316); box-shadow:0 0 8px rgba(249,115,22,.3); z-index:12; display:none; animation:scan 2s linear infinite; }
  .scanning .scan-line{ display:block; }
  @keyframes scan { 0%{top:20%}100%{top:80%} }
  .hidden-el { display:none!important; }
  input:focus { outline:none; box-shadow:0 0 0 4px rgba(245,158,11,.12); border-color:var(--accent); }
  /* table styles */
  .excel-table th { background:linear-gradient(to bottom,#f59e0b,#d97706); color:white; padding:10px; }
  .excel-table td { padding:8px; border:1px solid #e5e7eb; color:#111827; background:white; }
  .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border-radius:.6rem; font-weight:700; cursor:pointer; }
</style>

</head>
<body onload="checkConnection()" class="antialiased">
  <!-- Global Loader -->
  <div id="globalLoader" class="fixed inset-0 z-50 hidden-el items-center justify-center" style="background:rgba(0,0,0,.8);">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-500 mx-auto"></div>
      <p class="mt-4 text-white font-bold" id="loaderText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...</p>
    </div>
  </div>

  <!-- Root container -->
  <div id="appRoot" class="min-h-screen p-4 max-w-7xl mx-auto"></div>

<!-- Part 1 end â€” Ø¨Ø¹Ø¯ Ù…Ø§ ØªÙ„ØµÙ‚ Ù‡Ø°Ø§ Ø³Ø£Ø±Ø³Ù„ Part 2 -->
<!-- Part 2 / 4 â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø©ØŒ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (HTML) -->
<!-- ================================================ -->

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginModal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-50">
  <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl max-w-md w-full border-t-4 border-orange-600 relative text-center">
    <img src="unnamed.png" class="w-24 h-24 mx-auto mb-4 rounded-full shadow-lg border-2 border-orange-500" alt="Logo">
    <h2 class="text-3xl font-extrabold text-white mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div id="connectionStatus" class="mb-3 text-xs font-bold text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>

    <input type="text" id="loginName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID)" onkeydown="handleEnter(event,'loginPin')" class="w-full mb-3 bg-gray-700 border border-gray-600 p-3 rounded-xl text-center text-lg">
    <input type="password" id="loginPin" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (PIN)" onkeydown="handleEnter(event,'loginBtn')" class="w-full mb-4 bg-gray-700 border border-gray-600 p-3 rounded-xl text-center text-lg tracking-widest">

    <button id="loginBtn" onclick="loginSystem()" disabled class="w-full bg-gray-600 text-gray-400 py-3 rounded-xl font-bold text-lg cursor-not-allowed">Ø§Ù†ØªØ¸Ø±...</button>

    <p id="errorMsg" class="hidden mt-4 text-sm text-red-200 bg-red-900/60 p-3 rounded-lg border border-red-500"></p>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…ÙˆØ¯Ø§Ù„) -->
<div id="adminPanelModal" class="fixed inset-0 flex items-center justify-center hidden modal z-50 bg-black/90">
  <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl max-w-6xl w-full mx-4 border-2 border-red-600 h-[90vh] flex flex-col">
    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
      <h2 class="text-2xl font-bold text-red-500"><i class="fa-solid fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <div class="flex items-center gap-3">
        <button onclick="loadAllUsers()" class="btn bg-blue-600 text-white"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
        <button onclick="document.getElementById('adminPanelModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-2x"></i></button>
      </div>
    </div>

    <div class="bg-gray-700/50 p-4 rounded-xl mb-4 border border-gray-600">
      <h3 class="text-white font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù</h3>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div><label class="text-xs text-gray-400">ID</label><input type="text" id="newUsername" class="w-full bg-gray-800 border border-gray-500 p-2 rounded text-white text-center"></div>
        <div class="md:col-span-2"><label class="text-xs text-gray-400">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="newFullName" class="w-full bg-gray-800 border border-gray-500 p-2 rounded text-white text-center"></div>
        <div><label class="text-xs text-gray-400">PIN</label><input type="text" id="newPin" class="w-full bg-gray-800 border border-gray-500 p-2 rounded text-white text-center"></div>
        <div><label class="text-xs text-gray-400">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
          <select id="newRole" class="w-full bg-gray-800 border border-gray-500 p-2 rounded text-white text-center">
            <option value="user">Ù…ÙˆØ¸Ù</option>
            <option value="admin">Ù…Ø¯ÙŠØ±</option>
          </select>
        </div>
      </div>
      <div class="mt-3">
        <button onclick="addNewUser()" class="btn bg-green-600 text-white">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
      </div>
    </div>

    <div class="overflow-y-auto flex-1 bg-gray-900 rounded-xl border border-gray-700 p-3">
      <table class="w-full text-center text-sm text-gray-300">
        <thead class="bg-gray-800 text-gray-200 sticky top-0">
          <tr><th class="p-2">ID</th><th class="p-2 text-yellow-400">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th><th class="p-2">PIN</th><th class="p-2">Ø§Ù„Ø¯ÙˆØ±</th><th class="p-2">ØªØ­ÙƒÙ…</th></tr>
        </thead>
        <tbody id="usersTableBody" class="divide-y divide-gray-700"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
<div id="cardModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/90 z-40">
  <div class="bg-gray-900 rounded-2xl p-6 shadow-2xl max-w-4xl w-full mx-4 border-t-4 border-orange-600">
    <h2 class="text-2xl font-bold text-white mb-6 text-center">Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card-select bg-gray-800 p-4 rounded-xl cursor-pointer" onclick="selectCardType('100')">
        <img src="salamtk100.jpg" alt="100" class="mb-3 w-full rounded">
        <p class="text-xl font-bold text-purple-400 text-center">ÙØ¦Ø© 100</p>
      </div>
      <div class="card-select bg-gray-800 p-4 rounded-xl cursor-pointer" onclick="selectCardType('200')">
        <img src="salamtk200.jpg" alt="200" class="mb-3 w-full rounded">
        <p class="text-xl font-bold text-teal-400 text-center">ÙØ¦Ø© 200</p>
      </div>
      <div class="card-select bg-gray-800 p-4 rounded-xl cursor-pointer" onclick="selectCardType('500')">
        <img src="salamtk300.jpg" alt="500" class="mb-3 w-full rounded">
        <p class="text-xl font-bold text-yellow-400 text-center">ÙØ¦Ø© 500</p>
      </div>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø©) -->
<div id="mainContent" class="hidden max-w-7xl mx-auto p-4 md:p-6">
  <!-- header -->
  <div class="flex flex-wrap justify-between items-center bg-gray-800 p-4 rounded-2xl border border-gray-700 mb-6 shadow gap-3">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-white">
        <img src="unnamed.png" alt="logo" class="w-full h-full object-cover">
      </div>
      <div>
        <p class="text-xs text-gray-400">Ù…Ø±Ø­Ø¨Ø§Ù‹</p>
        <h1 id="displayEmployeeName" class="text-lg font-bold">--</h1>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="adminBtn" onclick="openAdminPanel()" class="hidden btn bg-red-600 text-white"><i class="fa-solid fa-users-gear"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
      <button onclick="document.getElementById('changePinModal').classList.remove('hidden')" class="btn bg-yellow-600 text-white"><i class="fa-solid fa-key"></i></button>
      <button onclick="location.reload()" class="btn bg-gray-700 text-white"><i class="fa-solid fa-power-off"></i> Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <!-- layout grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- left: Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ¹Ù…Ù„ÙŠØ§Øª OCR -->
    <div>
      <div id="cameraBox" class="camera-container scanning mb-3">
        <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
        <img id="imagePreview" class="hidden w-full h-full object-contain absolute top-0 left-0">
        <div class="scan-box"></div>
        <div class="scan-line"></div>
        <div class="absolute bottom-0 left-0 right-0 p-3 bg-black/60 text-center font-bold" id="statusText">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­.</div>
      </div>

      <button id="restartScanBtn" onclick="restartScan()" class="hidden btn bg-blue-600 text-white w-full mb-3">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·</button>

      <div class="grid grid-cols-3 gap-3 mb-6">
        <button onclick="startLiveScan()" class="btn bg-blue-600 text-white">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button onclick="toggleFlash()" id="flashBtn" class="hidden btn bg-yellow-500 text-white">ğŸ”¦ ÙÙ„Ø§Ø´</button>
        <div>
          <button onclick="document.getElementById('fileIn').click()" class="btn bg-gray-700 text-white w-full">ğŸ“‚ Ù…Ù„Ù</button>
          <input type="file" id="fileIn" class="hidden" accept="image/*,application/pdf" onchange="handleFile(this)">
        </div>
      </div>
    </div>

    <!-- right: Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ­ÙØ¸ -->
    <div class="bg-gray-800 rounded-2xl p-5 shadow">
      <div class="mb-4">
        <label class="text-xs text-orange-400 font-bold">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
        <input type="text" id="cardNo" class="w-full bg-gray-900 border-2 border-gray-600 p-3 rounded-xl text-center font-mono text-2xl font-bold">
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label class="text-xs text-gray-400">Ø§Ù„Ù…Ø±ÙŠØ¶</label>
          <input type="text" id="pName" class="w-full bg-gray-700 border border-gray-600 p-2 rounded">
        </div>
        <div>
          <label class="text-xs text-gray-400">Ø§Ù„Ù…Ù„Ù</label>
          <input type="text" id="fileNo" class="w-full bg-gray-700 border border-gray-600 p-2 rounded font-mono">
        </div>
        <div>
          <label class="text-xs text-gray-400">Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
          <input type="text" id="invNo" class="w-full bg-gray-700 border border-gray-600 p-2 rounded font-mono">
        </div>
        <div>
          <label class="text-xs text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="text" id="pDate" class="w-full bg-gray-700 border border-gray-600 p-2 rounded font-mono">
        </div>
      </div>

      <button onclick="saveEntryToCloud()" class="btn bg-gradient-to-r from-green-600 to-green-500 text-white w-full">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
  <div class="bg-white rounded-2xl overflow-hidden shadow mt-6 border border-gray-200">
    <div class="flex justify-between items-center bg-gray-100 p-3 border-b gap-2">
      <div class="flex items-center gap-2">
        <button onclick="exportXLS()" class="btn bg-green-600 text-white"><i class="fa-solid fa-file-excel"></i> ØªÙ†Ø²ÙŠÙ„ Excel</button>
        <div>
          <button onclick="document.getElementById('importFile').click()" class="btn bg-blue-600 text-white"><i class="fa-solid fa-folder-open"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
          <input type="file" id="importFile" class="hidden" accept=".xlsx,.xls" onchange="smartImport(this)">
        </div>
        <button onclick="document.getElementById('cardModal').classList.remove('hidden')" class="btn bg-orange-500 text-white">Ø§Ù„ÙØ¦Ø©</button>
      </div>
      <div class="text-right p-2">
        <div class="text-xs text-gray-500">Ø±ØµÙŠØ¯Ùƒ</div>
        <div id="totalProfitDisplay" class="text-2xl font-extrabold text-green-700">0 Ø±ÙŠØ§Ù„</div>
      </div>
    </div>

    <div class="overflow-x-auto max-h-[420px]">
      <table class="w-full text-sm text-center excel-table">
        <thead>
          <tr>
            <th class="p-2 w-12">#</th>
            <th class="p-2">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
            <th class="p-2 text-right">Ø§Ù„Ù…Ø±ÙŠØ¶</th>
            <th class="p-2">Ø§Ù„Ù…Ù„Ù</th>
            <th class="p-2">Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
            <th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th class="p-2">Ø§Ù„ÙØ¦Ø©</th>
            <th class="p-2">Ø§Ù„Ø±Ø¨Ø­</th>
            <th class="p-2 bg-gray-800 text-white">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>

  <canvas id="canvas" class="hidden"></canvas>
</div>

<!-- Part 2 end â€” Ø¨Ø¹Ø¯ Ù…Ø§ ØªÙ„ØµÙ‚ Ù‡Ø°Ø§ Ø³Ø£Ø±Ø³Ù„ Part 3 -->
<script>
/* ============================================================
    Part 3 â€” SMART OCR + CAMERA SYSTEM
   ============================================================ */

let stream = null;
let isScanning = false;
let scanInterval = null;

const video   = document.getElementById('video');
const canvas  = document.getElementById('canvas');
const cameraBox = document.getElementById('cameraBox');

/* ------------------------------------------------------------
    Start Camera
------------------------------------------------------------ */
async function startLiveScan() {
    try {
        document.getElementById('imagePreview').classList.add('hidden');
        video.classList.remove('hidden');

        cameraBox.classList.remove('success');
        cameraBox.classList.add('scanning');
        document.getElementById('statusText').textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­...";

        document.getElementById('restartScanBtn').classList.add('hidden');

        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        video.srcObject = stream;
        video.play();

        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities();
        if (caps.torch) {
            document.getElementById('flashBtn').classList.remove('hidden');
        }

        isScanning = true;
        scanInterval = setInterval(processFrame, 2000);

    } catch (err) {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message);
    }
}

/* ------------------------------------------------------------
    Toggle Flash
------------------------------------------------------------ */
async function toggleFlash() {
    if (!stream) return;
    const t = stream.getVideoTracks()[0];
    const caps = t.getCapabilities();
    if (!caps.torch) return;

    const cur = t.getSettings().torch || false;
    await t.applyConstraints({ advanced: [{ torch: !cur }] });
}

/* ------------------------------------------------------------
    Stop Camera
------------------------------------------------------------ */
function stopCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    clearInterval(scanInterval);
    isScanning = false;
}

/* ------------------------------------------------------------
    Process Frame â†’ OCR
------------------------------------------------------------ */
function processFrame() {
    if (!isScanning) return;

    const ctx = canvas.getContext("2d");
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0);

    runSmartOCR();
}

/* ------------------------------------------------------------
    Crop by % (relative area)
------------------------------------------------------------ */
function cropRelative(baseCanvas, x1, y1, x2, y2) {
    const w = baseCanvas.width;
    const h = baseCanvas.height;

    const c = document.createElement("canvas");
    const ctx = c.getContext("2d");

    let cw = (x2 - x1) * w;
    let ch = (y2 - y1) * h;

    c.width  = cw;
    c.height = ch;

    ctx.drawImage(
        baseCanvas,
        x1 * w, y1 * h, cw, ch,
        0, 0, cw, ch
    );

    return c;
}

/* ------------------------------------------------------------
    Fix OCR noise
------------------------------------------------------------ */
function fixOCR(text, type) {
    if (!text) return "";
    text = text.toUpperCase().trim();

    text = text.replace(/[\|!]/g, "I")
               .replace(/[^A-Z0-9\-\/]/g, "");

    if (type === "file" || type === "inv") {
        text = text.replace(/O/g, "0")
                   .replace(/I/g, "1");
        text = text.replace(/L(?=\d)/g, "1");
    }

    if (type === "file" && !text.endsWith("L")) text += "L";

    return text;
}

/* ------------------------------------------------------------
   Condition to auto-stop camera
------------------------------------------------------------ */
function isValidEnough(data) {
    return (data.file && data.file.length >= 5 && data.inv && data.inv.length >= 5);
}

/* ------------------------------------------------------------
    Recognize One Box
------------------------------------------------------------ */
function recognizeBox(crop, target) {
    Tesseract.recognize(crop, "eng").then(({ data: { text } }) => {

        let cleaned = fixOCR(text, target);

        if (target === "file") document.getElementById("fileNo").value = cleaned;
        if (target === "name") document.getElementById("pName").value = text.replace(/[^\w\s]/g, '').trim();
        if (target === "inv")  document.getElementById("invNo").value = cleaned;
        if (target === "date") document.getElementById("pDate").value = cleaned.replace(/\s+/g, "-");

        const data = {
            file: document.getElementById("fileNo").value.trim(),
            inv:  document.getElementById("invNo").value.trim(),
        };

        if (isValidEnough(data)) {
            stopCamera();
            cameraBox.classList.remove("scanning");
            cameraBox.classList.add("success");

            document.getElementById("statusText").innerHTML =
                "<span class='text-green-400'>âœ” ØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·</span>";

            document.getElementById("restartScanBtn").classList.remove("hidden");
        }
    });
}

/* ------------------------------------------------------------
    Main OCR Procedure
------------------------------------------------------------ */
function runSmartOCR() {

    if (!canvas.width || !canvas.height) return;

    const fileBox    = cropRelative(canvas, 0.02, 0.14, 0.45, 0.22);
    const nameBox    = cropRelative(canvas, 0.20, 0.14, 0.95, 0.22);
    const invoiceBox = cropRelative(canvas, 0.45, 0.29, 0.88, 0.37);
    const dateBox    = cropRelative(canvas, 0.05, 0.37, 0.40, 0.45);

    recognizeBox(fileBox, "file");
    recognizeBox(nameBox, "name");
    recognizeBox(invoiceBox, "inv");
    recognizeBox(dateBox, "date");
}

/* ------------------------------------------------------------
    Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
------------------------------------------------------------ */
function restartScan() {
    document.getElementById("restartScanBtn").classList.add("hidden");
    document.getElementById("statusText").textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­...";
    cameraBox.classList.remove("success");
    cameraBox.classList.add("scanning");
    startLiveScan();
}

/* ------------------------------------------------------------
    File Upload (image/pdf)
------------------------------------------------------------ */
async function handleFile(input) {

    const file = input.files[0];
    if (!file) return;

    stopCamera();
    video.classList.add("hidden");
    document.getElementById("restartScanBtn").classList.remove("hidden");

    const preview = document.getElementById("imagePreview");
    preview.classList.remove("hidden");

    /* ---------- PDF ---------- */
    if (file.type === "application/pdf") {
        const data = await file.arrayBuffer();
        const pdf  = await pdfjsLib.getDocument({ data }).promise;
        const page = await pdf.getPage(1);

        const viewport = page.getViewport({ scale: 2.0 });

        canvas.width  = viewport.width;
        canvas.height = viewport.height;

        const ctx = canvas.getContext("2d");

        await page.render({ canvasContext: ctx, viewport }).promise;

        preview.src = canvas.toDataURL();
        runSmartOCR();
        return;
    }

    /* ---------- IMAGE ---------- */
    const url = URL.createObjectURL(file);
    const img = new Image();

    img.onload = () => {
        canvas.width  = img.width;
        canvas.height = img.height;
        canvas.getContext("2d").drawImage(img, 0, 0);
        preview.src = canvas.toDataURL();
        runSmartOCR();
    };

    img.src = url;
}

</script>
<!-- END OF PART 3 -->
<!-- Part 3 â€” OCR + Camera + Cropping -->
<script>
let stream = null,
    isScanning = false,
    scanInterval = null;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const cameraBox = document.getElementById('cameraBox');

/* CAMERA START */
async function startLiveScan() {
  try {
    document.getElementById('imagePreview').classList.add('hidden');
    video.classList.remove('hidden');

    cameraBox.classList.remove('success');
    cameraBox.classList.add('scanning');
    document.getElementById('statusText').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...";
    document.getElementById('restartScanBtn').classList.add('hidden');

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    video.play();

    const track = stream.getVideoTracks()[0];
    if (track.getCapabilities().torch)
      document.getElementById('flashBtn').classList.remove('hidden');

    isScanning = true;
    scanInterval = setInterval(processFrame, 1800);
  }
  catch (e) { alert("Ø®Ø·Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + e.message); }
}

function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  clearInterval(scanInterval);
  isScanning = false;
}

async function toggleFlash() {
  if (!stream) return;
  const track = stream.getVideoTracks()[0];
  const caps = track.getCapabilities();
  if (caps.torch) {
    let current = track.getSettings().torch;
    await track.applyConstraints({ advanced: [{ torch: !current }] });
  }
}

function restartScan() {
  document.getElementById('restartScanBtn').classList.add('hidden');
  cameraBox.classList.remove('success');
  cameraBox.classList.add('scanning');
  document.getElementById('statusText').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...";
  startLiveScan();
}

/* FRAME PROCESSING */
function processFrame() {
  if (!isScanning) return;
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  runSmartOCR();
}

/* OCR HELPERS */
function cropRelative(base, x1, y1, x2, y2) {
  const w = base.width, h = base.height;
  const c = document.createElement('canvas');
  const ctx = c.getContext('2d');
  c.width = (x2 - x1) * w;
  c.height = (y2 - y1) * h;
  ctx.drawImage(base, x1*w, y1*h, (x2-x1)*w, (y2-y1)*h, 0, 0, c.width, c.height);
  return c;
}

function fixOCR(t, type) {
  if (!t) return "";
  t = t.toUpperCase().trim();
  t = t.replace(/[\|!]/g, 'I');
  t = t.replace(/[^A-Z0-9]/g, '');

  if (type === "file" || type === "inv") {
    t = t.replace(/O/g, "0").replace(/I/g, "1");
    t = t.replace(/L(?=\d)/g, "1");
    t = t.replace(/(?<=\d)L$/, "");
  }

  if (type === "file" && !t.endsWith("L")) t += "L";

  return t;
}

function isValidEnough(d) {
  return d.file?.length >= 5 && d.inv?.length >= 5;
}

function recognizeBox(crop, target) {
  Tesseract.recognize(crop, "eng").then(({ data:{ text } }) => {
    
    let cleaned = fixOCR(text, target);

    if (target === "file") document.getElementById("fileNo").value = cleaned;
    if (target === "name") document.getElementById("pName").value = text.replace(/[^\w\s]/g,"").trim();
    if (target === "inv") document.getElementById("invNo").value = cleaned;
    if (target === "date") document.getElementById("pDate").value = text.trim().replace(/\s+/g,"-");

    let d = {
      file: document.getElementById("fileNo").value.trim(),
      inv: document.getElementById("invNo").value.trim()
    };

    if (isValidEnough(d)) {
      stopCamera();
      cameraBox.classList.remove("scanning");
      cameraBox.classList.add("success");
      document.getElementById("statusText").innerHTML = "âœ”ï¸ ØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­";
      document.getElementById("restartScanBtn").classList.remove("hidden");
    }
  });
}

/* MAIN OCR CROPS (Positions You Requested) */
function runSmartOCR() {
  if (!canvas.width) return;

  const fileBox = cropRelative(canvas, 0.02, 0.14, 0.45, 0.22);
  const nameBox = cropRelative(canvas, 0.20, 0.14, 0.95, 0.22);
  const invBox  = cropRelative(canvas, 0.45, 0.29, 0.88, 0.37);
  const dateBox = cropRelative(canvas, 0.05, 0.37, 0.40, 0.45);

  recognizeBox(fileBox, "file");
  recognizeBox(nameBox, "name");
  recognizeBox(invBox, "inv");
  recognizeBox(dateBox, "date");
}

/* FILE IMPORT OCR */
async function handleFile(input) {
  const f = input.files[0];
  if (!f) return;

  stopCamera();
  video.classList.add("hidden");

  const preview = document.getElementById("imagePreview");
  preview.classList.remove("hidden");

  if (f.type === "application/pdf") {
    const buf = await f.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    const page = await pdf.getPage(1);
    const vp = page.getViewport({ scale: 2 });
    canvas.width = vp.width;
    canvas.height = vp.height;
    await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
    preview.src = canvas.toDataURL();
    runSmartOCR();
  } 
  else {
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = function () {
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext("2d").drawImage(img, 0, 0);
      preview.src = canvas.toDataURL();
      runSmartOCR();
    };
    img.src = url;
  }
}
</script>
<!-- Part 4 â€” Supabase + Saving + Import + Table -->
<script>
        // ==========================================
        // ğŸ”´ Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§
        // ==========================================
        const SUPABASE_URL = 'https://lhprxtnrnvkcedhcwpma.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxocHJ4dG5ybnZrY2VkaGN3cG1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODk3NzgsImV4cCI6MjA4MDc2NTc3OH0.4Xnqz0nWxpfp4TPEiQzuFmAsLzUWZt2PjJ3MtJmmKsc'; 
        // ==========================================

let db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentFullName = "";
let currentRole = "user";
let currentCardValue = "";
let currentCommission = 0;

let employeeData = [];

/* ================================
   2) LOGIN SYSTEM
================================ */
async function checkConnection() {
    const loginBtn = document.getElementById("loginBtn");
    const status = document.getElementById("connectionStatus");

    try {
        await db.from("users").select("*", { count: "exact", head: true });
        status.innerHTML = "<span class='text-green-400'>Ù…ØªØµÙ„ âœ”</span>";
        loginBtn.disabled = false;
        loginBtn.classList.remove("cursor-not-allowed");
        loginBtn.classList.remove("bg-gray-600");
        loginBtn.classList.add("bg-orange-600");
        loginBtn.textContent = "Ø¯Ø®ÙˆÙ„";
    } catch (e) {
        status.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
    }
}

async function loginSystem() {
    const id = document.getElementById("loginName").value.trim();
    const pin = document.getElementById("loginPin").value.trim();
    const err = document.getElementById("errorMsg");

    if (!id || !pin) {
        err.textContent = "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
        err.classList.remove("hidden");
        return;
    }

    const { data } = await db
        .from("users")
        .select("*")
        .eq("username", id)
        .eq("pin", pin)
        .maybeSingle();

    if (!data) {
        err.textContent = "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
        err.classList.remove("hidden");
        return;
    }

    currentUser = data.username;
    currentFullName = data.full_name || currentUser;
    currentRole = data.role;

    document.getElementById("displayEmployeeName").textContent = currentFullName;

    document.getElementById("loginModal").classList.add("hidden");
    document.getElementById("cardModal").classList.remove("hidden");

    if (currentRole === "admin")
        document.getElementById("adminBtn").classList.remove("hidden");

    fetchDataFromCloud();
}

function handleEnter(e, nextId) {
    if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById(nextId).focus();
        if (nextId === "loginBtn") loginSystem();
    }
}

/* ================================
   3) SELECT CARD CATEGORY
================================ */
function selectCardType(v) {
    currentCardValue = v;

    currentCommission =
        v === "100" ? 5 :
        v === "200" ? 10 :
        v === "500" ? 15 : 0;

    document.getElementById("currentCategoryBadge").textContent = `ÙØ¦Ø© ${v}`;
    document.getElementById("cardModal").classList.add("hidden");
    document.getElementById("mainContent").classList.remove("hidden");
}

/* ================================
   4) SAVE ENTRY (WITH DUPLICATE CHECK)
================================ */
async function saveEntryToCloud() {
    const card = document.getElementById("cardNo").value.trim();
    const file = document.getElementById("fileNo").value.trim();
    const inv = document.getElementById("invNo").value.trim();
    const date = document.getElementById("pDate").value.trim();
    const name = document.getElementById("pName").value.trim();

    if (!card || !file || !inv || !date || !name) {
        alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        return;
    }

    // Check duplicate invoice
    let { data: dupInv } = await db.from("invoices").select("id").eq("inv_no", inv).maybeSingle();
    if (dupInv) return alert("Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");

    // Check duplicate file
    let { data: dupFile } = await db.from("invoices").select("id").eq("file_no", file).maybeSingle();
    if (dupFile) return alert("Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");

    // Check duplicate card
    let { data: dupCard } = await db.from("invoices").select("id").eq("card_no", card).maybeSingle();
    if (dupCard) return alert("Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");

    const obj = {
        employee_name: currentFullName,
        employee_id: currentUser,
        card_no: card,
        file_no: file,
        inv_no: inv,
        inv_date: date,
        patient_name: name,
        remark: currentCardValue,
        profit: currentCommission
    };

    let { data, error } = await db.from("invoices").insert(obj).select();

    if (error) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");

    employeeData.push(data[0]);
    renderTable();
    refreshProfit();

    clearInputs();
}

function clearInputs() {
    ["cardNo", "fileNo", "invNo", "pDate", "pName"].forEach(id => {
        document.getElementById(id).value = "";
    });
}

/* ================================
   5) DELETE INVOICE
================================ */
async function deleteFromCloud(id) {
    if (!confirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;

    await db.from("invoices").delete().eq("id", id);
    employeeData = employeeData.filter(r => r.id !== id);
    renderTable();
    refreshProfit();
}

/* ================================
   6) FETCH DATA FROM SUPABASE
================================ */
async function fetchDataFromCloud() {
    let { data } = await db
        .from("invoices")
        .select("*")
        .eq("employee_name", currentFullName)
        .order("id", { ascending: true });

    employeeData = data || [];
    renderTable();
    refreshProfit();
}

/* ================================
   7) EXPORT TO EXCEL
================================ */
function exportXLS() {
    if (!employeeData.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");

    const header = ["#", "CARD NO", "PATIENT", "FILE", "INV", "DATE", "CAT", "PROFIT"];

    const rows = employeeData.map((r, i) => [
        i + 1,
        r.card_no,
        r.patient_name,
        r.file_no,
        r.inv_no,
        r.inv_date,
        r.remark,
        r.profit
    ]);

    const sheet = XLSX.utils.aoa_to_sheet([header, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, sheet, "DATA");

    XLSX.writeFile(wb, "invoices.xlsx");
}

/* ================================
   8) IMPORT FROM EXCEL
================================ */
async function smartImport(input) {
    let file = input.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = async function (e) {
        let wb = XLSX.read(e.target.result, { type: "binary" });
        let ws = wb.Sheets[wb.SheetNames[0]];
        let data = XLSX.utils.sheet_to_json(ws);

        let imported = 0;

        for (let r of data) {
            if (!r["INV"]) continue;

            let exist = await db.from("invoices").select("id").eq("inv_no", r["INV"]).maybeSingle();
            if (exist.data) continue;

            await db.from("invoices").insert({
                employee_name: currentFullName,
                employee_id: currentUser,
                card_no: r["CARD NO"],
                patient_name: r["PATIENT"],
                file_no: r["FILE"],
                inv_no: r["INV"],
                inv_date: r["DATE"],
                remark: r["CAT"],
                profit: r["PROFIT"]
            });

            imported++;
        }

        alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported} ÙØ§ØªÙˆØ±Ø©`);
        fetchDataFromCloud();
    };
    reader.readAsBinaryString(file);
}

/* ================================
   9) TABLE RENDER + PROFIT
================================ */
function renderTable() {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    employeeData.forEach((r, i) => {
        tbody.innerHTML += `
        <tr>
            <td>${i + 1}</td>
            <td>${r.card_no}</td>
            <td class="text-right">${r.patient_name}</td>
            <td>${r.file_no}</td>
            <td>${r.inv_no}</td>
            <td>${r.inv_date}</td>
            <td>${r.remark}</td>
            <td class="text-green-600 font-bold">+${r.profit}</td>
            <td>
                <button onclick="deleteFromCloud(${r.id})" class="text-red-600">
                    ğŸ—‘
                </button>
            </td>
        </tr>
        `;
    });
}

function refreshProfit() {
    const total = employeeData.reduce((a, c) => a + (c.profit || 0), 0);
    document.getElementById("totalProfitDisplay").textContent = total + " Ø±ÙŠØ§Ù„";
}

/* ================================
   10) ADMIN PANEL
================================ */
async function loadAllUsers() {
    const { data } = await db.from("users").select("*");

    const tbody = document.getElementById("usersTableBody");
    tbody.innerHTML = "";

    data.forEach(u => {
        tbody.innerHTML += `
        <tr>
          <td>${u.username}</td>
          <td>${u.full_name || "-"}</td>
          <td>${u.pin}</td>
          <td>${u.role}</td>
          <td>
            <button onclick="deleteUser(${u.id})" class="text-red-600">ğŸ—‘</button>
          </td>
        </tr>`;
    });
}

async function addNewUser() {
    const u = document.getElementById("newUsername").value.trim();
    const name = document.getElementById("newFullName").value.trim();
    const pin = document.getElementById("newPin").value.trim();
    const role = document.getElementById("newRole").value;

    if (!u || !pin) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

    await db.from("users").insert({
        username: u,
        full_name: name,
        pin,
        role
    });

    loadAllUsers();
}

/* ================================
   11) CHANGE PIN
================================ */
async function submitChangePin() {
    const old = document.getElementById("oldPinInput").value.trim();
    const newP = document.getElementById("newPinInput").value.trim();

    let { data } = await db
        .from("users")
        .select("*")
        .eq("username", currentUser)
        .eq("pin", old)
        .maybeSingle();

    if (!data) return alert("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­");

    await db.from("users").update({ pin: newP }).eq("id", data.id);

    alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
}
</script>
</body>
</html>

