<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SALAMTK OCR FINAL SECURE</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body{font-family:'Tajawal',sans-serif;background:#0f172a;color:white;}
.camera-container{position:relative;width:100%;height:300px;background:black;border:4px solid #ef4444;border-radius:16px;overflow:hidden;transition:0.4s;}
.camera-container.success{border-color:#10b981;box-shadow:0 0 25px #10b981;}
video,img{width:100%;height:100%;object-fit:cover;}
.scan-line{position:absolute;top:0;left:0;right:0;height:2px;background:#ef4444;box-shadow:0 0 4px #ef4444;animation:scan 2s infinite linear;display:none;}
.scanning .scan-line{display:block;}
@keyframes scan{0%{top:0;opacity:0;}20%{opacity:1;}100%{top:100%;opacity:0;}}
input:focus{outline:none;border-color:#f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,0.3);}
</style>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
</head>

<body class="bg-slate-900 min-h-screen p-4">

<!-- ====== Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ====== -->
<div class="max-w-4xl mx-auto">
    <div id="cameraBox" class="camera-container scanning shadow-xl bg-black mb-3">
        <video id="video" autoplay playsinline muted></video>
        <img id="imagePreview" class="hidden bg-black">
        <div class="scan-line"></div>
        <div class="absolute bottom-0 left-0 right-0 p-2 bg-black/70 text-center font-bold text-sm" id="statusText">Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­...</div>
    </div>

    <button id="restartScanBtn" onclick="restartScan()"
        class="hidden mt-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg w-full">
        ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
    </button>

    <div class="grid grid-cols-3 gap-3 mb-6">
        <button onclick="startLiveScan()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button onclick="toggleFlash()" id="flashBtn" class="hidden bg-yellow-500 hover:bg-yellow-400 text-white font-bold py-3 rounded-xl shadow-lg">ğŸ”¦ ÙÙ„Ø§Ø´</button>
        <div>
            <button onclick="document.getElementById('fileIn').click()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl shadow-lg">ğŸ“‚ Ù…Ù„Ù</button>
            <input type="file" id="fileIn" class="hidden" accept="image/*,application/pdf" onchange="handleFile(this)">
        </div>
    </div>
</div>

<!-- ====== Ø§Ù„Ø­Ù‚ÙˆÙ„ ====== -->
<div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl p-6 shadow-xl border border-gray-700">
    <div class="mb-4">
        <label class="text-xs font-bold text-orange-400 uppercase mb-1 block">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
        <input type="text" id="cardNo" class="w-full bg-gray-900 border-2 border-gray-600 p-4 rounded-xl text-center font-mono text-2xl font-bold">
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="text-[10px] font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
        <input type="text" id="pName" class="w-full bg-gray-700 border border-gray-600 p-3 rounded-lg text-sm font-bold text-gray-200"></div>

        <div><label class="text-[10px] font-bold text-gray-400">Ø§Ù„Ù…Ù„Ù</label>
        <input type="text" id="fileNo" class="w-full bg-gray-700 border border-gray-600 p-3 rounded-lg text-blue-300 font-mono font-bold text-sm"></div>

        <div><label class="text-[10px] font-bold text-gray-400">Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
        <input type="text" id="invNo" class="w-full bg-gray-700 border border-gray-600 p-3 rounded-lg font-mono font-bold text-red-400 text-sm"></div>

        <div><label class="text-[10px] font-bold text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input type="text" id="pDate" class="w-full bg-gray-700 border border-gray-600 p-3 rounded-lg font-mono font-bold text-green-400 text-sm"></div>
    </div>

    <button onclick="saveEntryToCloud()" class="w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded-xl font-bold text-lg shadow-xl">
        ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
    </button>
</div>

<!-- ======================================================================= -->
<script>
        // ==========================================
        // ğŸ”´ Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§
        // ==========================================
        const SUPABASE_URL = 'https://lhprxtnrnvkcedhcwpma.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxocHJ4dG5ybnZrY2VkaGN3cG1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODk3NzgsImV4cCI6MjA4MDc2NTc3OH0.4Xnqz0nWxpfp4TPEiQzuFmAsLzUWZt2PjJ3MtJmmKsc'; 
        // ==========================================
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let stream=null,isScanning=false,scanInterval=null;
const video=document.getElementById('video'); const canvas=document.createElement('canvas'); const cameraBox=document.getElementById('cameraBox');

/* ====== OCR Helpers ====== */
function cropRelative(c,x1,y1,x2,y2){
    const w=c.width,h=c.height;const t=document.createElement('canvas'),ctx=t.getContext('2d');
    t.width=(x2-x1)*w;t.height=(y2-y1)*h;
    ctx.drawImage(c,x1*w,y1*h,(x2-x1)*w,(y2-y1)*h,0,0,(x2-x1)*w,(y2-y1)*h);
    return t;
}
function fixOCR(t,type){
    if(!t) return"";t=t.toUpperCase().trim();
    t=t.replace(/[\|!]/g,'I').replace(/[^A-Z0-9\-\/]/g,'');
    if(type==='file'||type==='inv'){t=t.replace(/O/g,'0').replace(/I/g,'1').replace(/L(?=\d)/g,'1').replace(/(?<=\d)L$/,'');}
    if(type==='file'&&!t.endsWith('L'))t+='L';return t;
}
function isValidEnough(d){return(d.file&&d.file.length>=6&&d.inv&&d.inv.length>=6);}

/* ====== OCR Per Box ====== */
function recognizeBox(c,tp){
    Tesseract.recognize(c,'eng').then(({data:{text}})=>{
        let f=fixOCR(text,tp);
        if(tp==='file')document.getElementById('fileNo').value=f;
        if(tp==='name')document.getElementById('pName').value=text.replace(/[^\w\s]/g,'').trim();
        if(tp==='inv')document.getElementById('invNo').value=f;
        if(tp==='date')document.getElementById('pDate').value=text.replace(/\s/g,'-');

        const d={file:document.getElementById('fileNo').value.trim(),inv:document.getElementById('invNo').value.trim()};
        if(isValidEnough(d)){
            stopCamera();
            cameraBox.classList.remove('scanning');cameraBox.classList.add('success');
            document.getElementById('statusText').innerHTML="<span class='text-green-400'>âœ”ï¸ ØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­</span>";
            document.getElementById('restartScanBtn').classList.remove('hidden');
        }
    });
}

/* ====== Scan Loop ====== */
function runSmartOCR(){
    if(!isScanning)return;
    const ctx=canvas.getContext('2d');canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);
    recognizeBox(cropRelative(canvas,0.02,0.14,0.45,0.22),'file');
    recognizeBox(cropRelative(canvas,0.20,0.14,0.95,0.22),'name');
    recognizeBox(cropRelative(canvas,0.45,0.29,0.88,0.37),'inv');
    recognizeBox(cropRelative(canvas,0.05,0.37,0.40,0.45),'date');
}

/* ====== Camera ====== */
async function startLiveScan(){
    document.getElementById('restartScanBtn').classList.add('hidden');
    try{
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        video.srcObject=stream;video.play();
        const t=stream.getVideoTracks()[0];if(t.getCapabilities().torch)document.getElementById('flashBtn').classList.remove('hidden');
        isScanning=true;scanInterval=setInterval(runSmartOCR,2000);
    }catch(e){alert("Ø®Ø·Ø£ ÙƒØ§Ù…ÙŠØ±Ø§: "+e.message);}
}
async function toggleFlash(){
    if(stream){const t=stream.getVideoTracks()[0],c=t.getCapabilities();
        if(c.torch)await t.applyConstraints({advanced:[{torch:!t.getSettings().torch}]});}
}
function stopCamera(){if(stream)stream.getTracks().forEach(t=>t.stop());clearInterval(scanInterval);isScanning=false;}
function restartScan(){
    document.getElementById('restartScanBtn').classList.add('hidden');
    document.getElementById('statusText').innerHTML="<span class='text-gray-300'>Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­...</span>";
    cameraBox.classList.remove('success');cameraBox.classList.add('scanning');
    startLiveScan();
}

/* ====== File Upload ====== */
async function handleFile(i){
    const f=i.files[0];if(!f)return;stopCamera();video.classList.add('hidden');document.getElementById('imagePreview').classList.remove('hidden');
    if(f.type==="application/pdf"){
        const d=await f.arrayBuffer(),p=await pdfjsLib.getDocument({data:d}).promise;
        const pg=await p.getPage(1),vp=pg.getViewport({scale:2});canvas.width=vp.width;canvas.height=vp.height;
        await pg.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;
        document.getElementById('imagePreview').src=canvas.toDataURL();runSmartOCR();
    }else{
        document.getElementById('imagePreview').src=URL.createObjectURL(f);
        const img=new Image();img.onload=function(){canvas.width=img.width;canvas.height=img.height;canvas.getContext('2d').drawImage(img,0,0);runSmartOCR();};img.src=document.getElementById('imagePreview').src;}
}

/* ====== SAVE with FULL PROTECTION ====== */
async function saveEntryToCloud(){
    const card=document.getElementById('cardNo').value.trim();
    const file=document.getElementById('fileNo').value.trim();
    const inv=document.getElementById('invNo').value.trim();
    const date=document.getElementById('pDate').value.trim();
    const name=document.getElementById('pName').value.trim();

    if(!card||!file||!inv||!date||!name){alert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");return;}

    const {data:dup_inv}=await db.from("invoices").select("id").eq("inv_no",inv).maybeSingle();
    if(dup_inv){alert("â›” Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§!");return;}

    const {data:dup_file}=await db.from("invoices").select("id").eq("file_no",file).maybeSingle();
    if(dup_file){alert("â›” Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§!");return;}

    const {data:dup_card}=await db.from("invoices").select("id").eq("card_no",card).maybeSingle();
    if(dup_card){alert("â›” Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§!");return;}

    const entry={card_no:card,patient_name:name,file_no:file,inv_no:inv,inv_date:date};
    const {error}=await db.from("invoices").insert(entry);

    if(error){alert("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: "+error.message);}
    else{alert("ğŸ‘Œ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");}
}
</script>

</body>
</html>
