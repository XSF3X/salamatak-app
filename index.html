<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù†Ø¸Ø§Ù… Ø³Ù„Ø§Ù…ØªÙƒ (V38)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>

<style>
body {background:#111827;color:white;font-family:"Segoe UI",sans-serif;}
.camera-container{position:relative;width:100%;height:300px;background:#000;border-radius:16px;overflow:hidden;border:4px solid #ef4444;transition:border-color .3s;}
.camera-container.success{border-color:#10b981;box-shadow:0 0 25px #10b981;}
video{width:100%;height:100%;object-fit:cover;}
.scan-line{position:absolute;top:0;left:0;right:0;height:2px;background:#ef4444;box-shadow:0 0 4px #ef4444;animation:scan 2s infinite linear;display:none;}
.scanning .scan-line{display:block;}
.modal{z-index:60;background:rgba(0,0,0,.95);}
.card-img-btn{cursor:pointer;transition:.2s;border-radius:12px;overflow:hidden;border:3px solid transparent;}
.card-img-btn:hover{transform:scale(1.05);box-shadow:0 10px 20px rgba(0,0,0,.5);border-color:#f59e0b;}
.excel-table th{background:#c2410c;color:white;border:1px solid #4b5563;}
.excel-table td{border:1px solid #374151;color:#1f2937;background:white;}
#globalLoader{z-index:100;background:rgba(0,0,0,.9);}
</style>
</head>
<body class="p-4 md:p-6" onload="checkConnection()">

<!-- =============== Loader =============== -->
<div id="globalLoader" class="fixed inset-0 flex flex-col items-center justify-center hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-orange-600"></div>
    <p class="mt-4 text-white font-bold tracking-wider">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
</div>

<!-- =============== Login =============== -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 z-50">
<div class="bg-gray-800 rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4 text-center border-t-8 border-orange-600 relative">

    <!-- ğŸ‘ˆ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø­Ù„ Ø§Ù„Ø®Ø·Ø£ -->
    <div id="connectionStatus" class="absolute top-2 left-0 right-0 text-xs font-bold text-gray-500">ÙØ­Øµ...</div>

    <div class="mb-6 mt-4"><i class="fa-solid fa-shield-halved text-6xl text-orange-500"></i></div>
    <h2 class="text-3xl font-extrabold text-white mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="text" id="loginName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID)" class="w-full bg-gray-700 border-2 border-gray-600 p-3 rounded-lg font-bold text-lg text-white mb-3 text-center">
    <div class="relative mb-6">
        <input type="password" id="loginPin" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ" class="w-full bg-gray-700 border-2 border-gray-600 p-3 rounded-lg font-bold text-lg text-white text-center tracking-widest">
        <button onclick="togglePin()" class="absolute left-3 top-3 text-gray-400 hover:text-white"><i class="fa-solid fa-eye" id="eyeIcon"></i></button>
    </div>
    <button onclick="loginSystem()" id="loginBtn" class="w-full bg-gray-600 text-gray-400 py-3 rounded-xl font-bold text-lg shadow-lg cursor-not-allowed">Ø§Ù†ØªØ¸Ø±...</button>
    <div id="errorMsg" class="mt-4 text-red-300 text-xs font-bold hidden bg-red-900/50 p-3 rounded border border-red-500 text-right"></div>
</div>
</div>

<!-- =============== Main Card Modal =============== -->
<div id="cardModal" class="fixed inset-0 flex items-center justify-center hidden modal">
<div class="bg-gray-900 rounded-2xl p-6 shadow-2xl max-w-5xl w-full mx-4 border-t-4 border-orange-600">
    <h2 class="text-2xl font-bold text-white mb-6 text-center">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ù„Ù„Ø¨Ø¯Ø¡</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card-img-btn" onclick="selectCardType('100')"><img src="salamtk100.jpg"><p class="text-center mt-2 font-bold text-purple-400 text-lg">ÙØ¦Ø© 100 Ø±ÙŠØ§Ù„</p></div>
        <div class="card-img-btn" onclick="selectCardType('200')"><img src="salamtk200.jpg"><p class="text-center mt-2 font-bold text-teal-400 text-lg">ÙØ¦Ø© 200 Ø±ÙŠØ§Ù„</p></div>
        <div class="card-img-btn" onclick="selectCardType('500')"><img src="salamtk300.jpg"><p class="text-center mt-2 font-bold text-yellow-400 text-lg">ÙØ¦Ø© 500 Ø±ÙŠØ§Ù„</p></div>
    </div>
</div>
</div>

<!-- =============== Main Content =============== -->
<div id="mainContent" class="hidden max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-6 bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg flex-wrap gap-2">
        <div class="flex items-center gap-4">
            <div class="bg-gradient-to-br from-orange-500 to-red-600 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-2xl shadow-md"><i class="fa-solid fa-user-check"></i></div>
            <div>
                <p class="text-xs text-gray-400 uppercase">Ù…Ø±Ø­Ø¨Ø§Ù‹</p>
                <h1 class="text-xl font-bold text-white" id="displayEmployeeName">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
            </div>
        </div>
        <button onclick="fetchDataFromCloud()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm font-bold"><i class="fa-solid fa-sync"></i></button>
    </div>

    <div class="bg-gray-800 rounded-2xl p-6">
        <input id="cardNo" class="w-full bg-gray-900 border-2 border-gray-600 p-4 rounded-xl font-mono text-2xl text-white text-center" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
        <button onclick="saveEntryToCloud()" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white py-4 rounded-xl font-bold text-lg shadow-xl flex items-center justify-center gap-2"><span>Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ</span><i class="fa-solid fa-cloud-arrow-up"></i></button>
    </div>
</div>

<script>
/* ================= Supabase Config ================= */
const SUPABASE_URL="https://lhprxtnrnvkcedhcwpma.supabase.co"; const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxocHJ4dG5ybnZrY2VkaGN3cG1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODk3NzgsImV4cCI6MjA4MDc2NTc3OH0.4Xnqz0nWxpfp4TPEiQzuFmAsLzUWZt2PjJ3MtJmmKsc";
let db=null,currentUser=null,currentRole=null,currentFullName='';
let employeeData=[],currentCardValue='',currentCommission=0;

/* ================= Login ================= */
async function loginSystem(){
    const u=document.getElementById('loginName').value.trim();
    const p=document.getElementById('loginPin').value.trim();
    if(!u||!p) return showError("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
    showLoader(true);
    const {data,error}=await db.from('users').select('*').eq('username',u).eq('pin',p).maybeSingle();
    showLoader(false);
    if(error||!data) return showError("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
    currentUser=data.username;
    currentRole=data.role;
    currentFullName=data.full_name||data.username;  // ğŸ‘ˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
    enterSystem();
}
function enterSystem(){
    document.getElementById('displayEmployeeName').textContent=currentFullName;
    document.getElementById('loginModal').classList.add('hidden');
    document.getElementById('cardModal').classList.remove('hidden');
}

/* ================= Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø© ================= */
function selectCardType(v){
    currentCardValue=v;currentCommission=(v==='100'?5:(v==='200'?10:15));
    document.getElementById('cardModal').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
}

/* ================= Ø­ÙØ¸ ÙÙˆØ§ØªÙŠØ± ================= */
async function saveEntryToCloud(){
    const c=document.getElementById('cardNo').value.trim();
    if(!c) return alert("Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø·Ù„ÙˆØ¨");
    showLoader(true);
    await db.from('invoices').insert([{employee_name:currentFullName,card_no:c,remark:currentCardValue,profit:currentCommission}]);
    showLoader(false);
    alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    document.getElementById('cardNo').value='';
}

/* ================= Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ================= */
async function fetchDataFromCloud(){
    showLoader(true);
    const {data}=await db.from('invoices').select('*').eq('employee_name',currentFullName); // ğŸ‘ˆ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
    showLoader(false);
    employeeData=data||[];
}

/* ================= Ø§Ù„ØªØ´ØºÙŠÙ„ ================= */
async function checkConnection(){
    const st=document.getElementById('connectionStatus'),btn=document.getElementById('loginBtn');
    try{
        db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
        await db.from('users').select('*',{count:'exact',head:true});
        st.innerHTML="âœ” Ù…ØªØµÙ„"; btn.disabled=false; btn.classList.replace('bg-gray-600','bg-orange-600'); btn.classList.replace('text-gray-400','text-white'); btn.textContent="Ø¯Ø®ÙˆÙ„ ğŸ”";
    }catch(e){st.innerHTML="âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„";}
}

/* ================= Utils ================= */
function showLoader(v){document.getElementById('globalLoader').classList.toggle('hidden',!v);}
function showError(t){const e=document.getElementById('errorMsg');e.textContent=t;e.classList.remove('hidden');}
function togglePin(){const p=document.getElementById('loginPin'),i=document.getElementById('eyeIcon');if(p.type==="password"){p.type="text";i.classList.replace("fa-eye","fa-eye-slash")}else{p.type="password";i.classList.replace("fa-eye-slash","fa-eye")}}
</script>

</body>
</html>
