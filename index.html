<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SALAMTK (V55)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body { font-family: 'Segoe UI', Tahoma; background-color:#0f172a; color:white; }
.excel-table th { background:#c2410c; color:#fff; }
.excel-table td { border:1px solid #374151; background:white; color:#000; }
</style>
</head>

<body onload="checkConnection()">

<!-- ====================== LOADER ====================== -->
<div id="globalLoader" class="fixed inset-0 bg-black/90 flex flex-col items-center justify-center hidden">
<div class="animate-spin h-16 w-16 rounded-full border-t-4 border-orange-500"></div>
<p class="mt-4 text-white font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</p>
</div>

<!-- ====================== LOGIN ====================== -->
<div id="loginModal" class="fixed inset-0 bg-black flex items-center justify-center z-50">
<div class="bg-gray-800 rounded-2xl p-8 shadow-2xl max-w-md w-full border-t-8 border-orange-600 text-center">
<h2 class="text-3xl font-bold text-white mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
<input type="text" id="loginName" placeholder="ID" onkeydown="handleEnter(event,'loginPin')" class="w-full mb-3 bg-gray-700 border border-gray-600 p-3 rounded-lg text-center">
<input type="password" id="loginPin" placeholder="PIN" onkeydown="handleEnter(event,'loginBtn')" class="w-full mb-6 bg-gray-700 border border-gray-600 p-3 rounded-lg text-center">
<button onclick="loginSystem()" id="loginBtn" disabled class="w-full bg-gray-600 text-gray-400 py-3 rounded-xl font-bold cursor-not-allowed">Ø§Ù†ØªØ¸Ø±...</button>
<p id="errorMsg" class="hidden mt-4 text-xs text-red-300 bg-red-900/50 p-2 rounded"></p>
</div>
</div>

<!-- ====================== CARD SELECT ====================== -->
<div id="cardModal" class="hidden fixed inset-0 flex items-center justify-center">
<div class="bg-gray-900 rounded-2xl p-6 max-w-3xl w-full mx-4 border-t-4 border-orange-600">
<h2 class="text-2xl font-bold text-center mb-6">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center font-bold">
<div onclick="selectCardType('500')" class="cursor-pointer hover:scale-105"><img src="salamtk300.jpg"><p class="mt-2 text-yellow-400">ÙØ¦Ø© 500 Ø±ÙŠØ§Ù„</p></div>
<div onclick="selectCardType('200')" class="cursor-pointer hover:scale-105"><img src="salamtk200.jpg"><p class="mt-2 text-teal-400">ÙØ¦Ø© 200 Ø±ÙŠØ§Ù„</p></div>
<div onclick="selectCardType('100')" class="cursor-pointer hover:scale-105"><img src="salamtk100.jpg"><p class="mt-2 text-purple-400">ÙØ¦Ø© 100 Ø±ÙŠØ§Ù„</p></div>
</div>
</div>
</div>

<!-- ====================== MAIN ====================== -->
<div id="mainContent" class="hidden max-w-5xl mx-auto p-4">
<!-- HEADER -->
<div class="flex justify-between bg-gray-800 p-4 rounded-xl border border-gray-700 mb-4">
<div>
<p class="text-xs text-gray-400">Ù…Ø±Ø­Ø¨Ø§Ù‹</p>
<h1 class="text-xl font-bold" id="displayEmployeeName">--</h1>
</div>
<div class="flex gap-2">
<button id="adminBtn" onclick="openActivity()" class="hidden bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold"><i class="fa-solid fa-gear"></i> Ø§Ù„Ø³Ø¬Ù„</button>
<button onclick="document.getElementById('changePinModal').classList.remove('hidden')" class="bg-yellow-500 px-4 py-2 rounded-lg"><i class="fa-solid fa-key"></i></button>
<button onclick="location.reload()" class="bg-gray-600 px-4 py-2 rounded-lg"><i class="fa-solid fa-right-from-bracket"></i></button>
</div>
</div>

<!-- MANUAL ENTRY -->
<div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
<div class="grid grid-cols-2 gap-4">
<input id="cardNo" class="bg-gray-900 border border-gray-600 p-3 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
<input id="pNameInput" class="bg-gray-900 border border-gray-600 p-3 rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
<input id="fileNoInput" class="bg-gray-900 border border-gray-600 p-3 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù">
<input id="invNoInput" class="bg-gray-900 border border-gray-600 p-3 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
<input id="pDateInput" class="bg-gray-900 border border-gray-600 p-3 rounded" placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®">
<input disabled class="bg-gray-900 border border-gray-600 p-3 rounded text-center font-bold" id="currentCategoryBadge" value="--">
</div>
<button onclick="saveEntryToCloud()" class="mt-4 w-full bg-green-600 py-3 font-bold rounded-xl">Ø­ÙØ¸</button>
</div>

<!-- TABLE -->
<div class="mt-6 bg-white rounded-xl overflow-hidden">
<table class="w-full text-sm text-gray-700 excel-table bg-white">
<thead><tr><th>SN</th><th>CARD</th><th>PATIENT</th><th>FILE</th><th>INV</th><th>DATE</th><th>CAT</th><th>PROFIT</th><th>#</th></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- ====================== CHANGE PIN MODAL ====================== -->
<div id="changePinModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/80">
<div class="bg-gray-900 p-6 rounded-xl w-80 text-center">
<h3 class="text-xl font-bold mb-2">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</h3>
<input id="oldPinInput" placeholder="Ø§Ù„Ø­Ø§Ù„ÙŠ" class="w-full mb-2 bg-gray-800 p-2 rounded">
<input id="newPinInput" placeholder="Ø§Ù„Ø¬Ø¯ÙŠØ¯" class="w-full mb-4 bg-gray-800 p-2 rounded">
<button onclick="submitChangePin()" class="bg-yellow-500 px-4 py-2 rounded w-full">ØªØºÙŠÙŠØ±</button>
</div>
</div>

<!-- ====================== ACTIVITY LOG ====================== -->
<div id="activityModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center">
<div class="bg-gray-900 p-6 rounded-xl max-w-3xl w-full border border-gray-600">
<h2 class="text-xl font-bold mb-4">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h2>
<table class="w-full text-sm bg-white text-gray-700 excel-table">
<thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
<tbody id="logBody"></tbody>
</table>
<button onclick="activityModal.classList.add('hidden')" class="mt-4 bg-red-600 px-4 py-2 rounded text-white">Ø¥ØºÙ„Ø§Ù‚</button>
</div>
</div>

<script>
/* ========= CONFIG ========= */
        const SUPABASE_URL = 'https://lhprxtnrnvkcedhcwpma.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxocHJ4dG5ybnZrY2VkaGN3cG1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODk3NzgsImV4cCI6MjA4MDc2NTc3OH0.4Xnqz0nWxpfp4TPEiQzuFmAsLzUWZt2PjJ3MtJmmKsc'; 
        
let db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null, currentRole = "user", currentFullName = "";
let employeeData = [], currentCardValue = "", currentCommission = 0;

/* ========= HELPERS ========= */
function showLoader(b){globalLoader.classList.toggle('hidden',!b);}
function showError(m){errorMsg.textContent=m;errorMsg.classList.remove('hidden');}
function handleEnter(e,n){if(e.key==="Enter"){e.preventDefault();document.getElementById(n).focus();}}

/* ========= INIT ========= */
async function checkConnection(){
try{await db.from("users").select("*");loginBtn.disabled=false;loginBtn.classList.remove("cursor-not-allowed");loginBtn.textContent="Ø¯Ø®ÙˆÙ„ ğŸ”";}
catch(e){alert("âš  Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");}
}

/* ========= LOGIN ========= */
async function loginSystem(){
showLoader(true);
const {data,error}=await db.from("users").select("*").eq("username",loginName.value.trim()).eq("pin",loginPin.value.trim()).maybeSingle();
showLoader(false);
if(error||!data)return showError("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
if(!data.full_name)return alert("âš  Ø§Ø³Ù…Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
currentUser=data.username;currentRole=data.role;currentFullName=data.full_name;
await logAction("LOGIN",`ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„`);
enterSystem();
}
function enterSystem(){
loginModal.classList.add("hidden");
cardModal.classList.remove("hidden");
displayEmployeeName.textContent=currentFullName;
if(currentRole==="admin")adminBtn.classList.remove("hidden");
fetchDataFromCloud();
}

/* ========= LOG ========= */
async function logAction(action,details=""){await db.from("activity_log").insert([{username:currentUser,action,details}]);}
async function openActivity(){
activityModal.classList.remove("hidden");
const {data}=await db.from("activity_log").select("*").order("id",{ascending:false}).limit(50);
logBody.innerHTML="";
data.forEach(r=>logBody.innerHTML+=`<tr><td>${r.username}</td><td>${r.action}</td><td>${r.details}</td><td>${r.created_at}</td></tr>`);
}

/* ========= CARD SELECT ========= */
function selectCardType(v){
currentCardValue=v;
currentCommission=v==="500"?15:v==="200"?10:5;
currentCategoryBadge.value=`ÙØ¦Ø© ${v}`;
cardModal.classList.add("hidden");
mainContent.classList.remove("hidden");
cardNo.focus();
}

/* ========= SAVE ========= */
async function saveEntryToCloud(){
if(!cardNo.value||!pNameInput.value||!fileNoInput.value||!invNoInput.value||!pDateInput.value)return alert("âš  Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
const {data:ex}=await db.from("invoices").select("id").eq("employee_id",currentUser).eq("card_no",cardNo.value).maybeSingle();
if(ex)return alert("âŒ Ù…ÙƒØ±Ø±!");
const entry={employee_id:currentUser,card_no:cardNo.value,patient_name:pNameInput.value,file_no:fileNoInput.value,inv_no:invNoInput.value,inv_date:pDateInput.value,remark:currentCardValue,profit:currentCommission};
await db.from("invoices").insert([entry]);
await logAction("ADD_INVOICE",cardNo.value);
alert("ØªÙ… âœ”");
fetchDataFromCloud();
clearInputs();
}
function clearInputs(){cardNo.value=fileNoInput.value=pNameInput.value=invNoInput.value=pDateInput.value="";cardNo.focus();}

/* ========= GET ========= */
async function fetchDataFromCloud(){
const {data}=await db.from("invoices").select("*").eq("employee_id",currentUser);
employeeData=data||[];renderTable();
}

/* ========= DELETE ========= */
async function deleteFromCloud(id,card){
if(!confirm("Ø­Ø°ÙØŸ"))return;
await db.from("invoices").delete().eq("id",id);
await logAction("DELETE_INVOICE",card);
employeeData=employeeData.filter(i=>i.id!==id);renderTable();
}

/* ========= CHANGE PIN ========= */
async function submitChangePin(){
const {data:ch}=await db.from("users").select("id").eq("username",currentUser).eq("pin",oldPinInput.value.trim()).maybeSingle();
if(!ch)return alert("âŒ Ø®Ø·Ø£");
await db.from("users").update({pin:newPinInput.value.trim()}).eq("id",ch.id);
await logAction("CHANGE_PIN");
alert("ØªÙ… âœ”");changePinModal.classList.add("hidden");
}

/* ========= TABLE ========= */
function renderTable(){
tbody.innerHTML="";
employeeData.forEach((r,i)=>tbody.innerHTML+=`
<tr><td>${i+1}</td><td>${r.card_no}</td><td>${r.patient_name}</td><td>${r.file_no}</td><td>${r.inv_no}</td><td>${r.inv_date}</td><td>${r.remark}</td><td>${r.profit}</td>
<td><button onclick="deleteFromCloud(${r.id},'${r.card_no}')" class="text-red-600">ğŸ—‘</button></td></tr>`);
}
</script>

</body>
</html>
